<!DOCTYPE html>
<html lang="en">
	<meta charset="UTF-8" />
	<title>HidroWeb data processing tool</title>
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<link rel="icon" type="image/png" href="favicon.svg" />
	<style>
		@import url('https://fonts.googleapis.com/css?family=Nunito&display=swap');
		html,
		body {
			font-family: Nunito, sans-serif;
			font-size: 18px;
			box-sizing: content-box;
			padding: 0;
			margin: 0;
			background-color: #eee;
		}

		body {
			padding: 1em;
		}

		*,
		*:before,
		*:after {
			box-sizing: inherit;
		}

		a,
		a:visited,
		a:active {
			text-decoration: underline;
			color: #0004ff;
		}

		.btn_process {
			padding: 20px;
			font-size: 30px;
			background-color: rgb(0, 119, 255);
			color: #000000;
			border: 3px solid #000000;
			cursor: pointer;
		}
		.result p {
			margin: 0;
		}
	</style>
	<script src="outputColumnsOrder.js"></script>
	<script src="jquery-3.6.0.min.js"></script>
	<script src="zip.min.js"></script>
	<script src="sample-input.js"></script>
	<script>
		var App = {
			clearResult: function (msg) {
				$('.result').html('');
			},
			addResult: function (msg) {
				const $elem = $('<p>' + msg + '<p>');
				$('.result').append($elem);
				return $elem;
			},
			isoDateToMonths: function (dt) {
				let dtParts = dt.split('-').slice(0, 2);
				const yearMonths = parseInt(dtParts[0], 10) * 12;
				const monthMonths = parseInt(dtParts[1], 10);
				return yearMonths + monthMonths;
			},
			isoDateMonthsDiff: function (d1, d2) {
				// '2020-01-31' - '2020-03-01' = 2. Ignores days
				let d1Months = App.isoDateToMonths(d1);
				let d2Months = App.isoDateToMonths(d2);
				return Math.abs(d1Months - d2Months);
			},
			getIncrementedMonthIsoDate: function (isoDate) {
				let [years, months, days] = isoDate.split('-').slice(0, 3);
				if (++months > 12) {
					years++;
					months = 1;
				}
				return years + '-' + months.toString().padStart(2, '0') + '-' + days;
			},
			convertToCsv: function (data) {
				var rows = [];
				let columnsOmmitedFromOutput = [];
				var colHeaders = [];
				Object.keys(data[0]).forEach((colName) => {
					if (outputColumnsOrder.includes(colName)) {
						colHeaders.push(colName);
					} else {
						columnsOmmitedFromOutput.push(colName);
					}
				});
				rows.push(colHeaders.join(','));

				data.forEach((record) => {
					var rowData = [];
					Object.keys(record).forEach((colName) => {
						if (outputColumnsOrder.includes(colName)) {
							rowData.push(record[colName]);
						}
					});
					rows.push(rowData.join(','));
				});

				return [rows.join('\n'), columnsOmmitedFromOutput];
			},
			getYearMonthFromIso: function (isoDate) {
				return isoDate.split('-').slice(0, 2).join('-');
			},
			setLinkDownload: function ($link, filename, contents) {
				$link.attr('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(contents)).attr('download', filename);
			},
			processCSVButtonClick: function () {
				try {
					App.clearResult();
					App.addResult('Loading CSV...');
					const lines = $('.textarea_csv').val().split('\n');
					if (lines.length < 2) {
						throw new Error('Please load a CSV with at least 2 lines.');
					}
					App.addResult('Removing non-data lines 1 to 14...');
					lines.splice(0, 14);
					App.addResult('Parsing CSV header...');
					const cols = lines.splice(0, 1)[0].split(';');
					cols.pop(); //  remove last empty col after ";"
					cols.push('Duplicated', 'GapFilled');

					App.addResult('Reading CSV entries into an array [{col1: 1, col2: 2}, {col1: 3, col2: 4}]...');
					const data = [];
					lines.forEach((line, lineNumber) => {
						const lineObj = {};
						line.split(';').forEach((cell, colNumber) => {
							if (colNumber > cols.length - 1) return; // skip last empty col after ";"
							const colName = cols[colNumber];
							if (colName == 'Data') {
								cell = cell.split('/').reverse().join('-');
							}
							lineObj[colName] = cell;
						});
						lineObj['Duplicated'] = 0;
						lineObj['GapFilled'] = 0;
						data.push(lineObj);
					});
					let emptyEntry = jQuery.extend({}, data[0]);
					Object.entries(emptyEntry).forEach(([key, value]) => {
						emptyEntry[key] = '';
					});

					App.addResult('Sorting entries in chronological order...');
					data.sort((x, y) => {
						if (x.Data < y.Data) return -1;
						if (x.Data > y.Data) return 1;
						return 0;
					});

					App.addResult('Insert missing months...');
					const newData = [data[0]];
					let lastEntryDate = data[0].Data;
					let filledGaps = [];
					data.forEach((entry, index) => {
						if (index == 0) return;
						const lastEntryDateInMonths = App.isoDateToMonths(lastEntryDate);
						const monthsMissing = Math.max(0, App.isoDateMonthsDiff(lastEntryDate, entry.Data) - 1);
						let incrementedIsoDate = lastEntryDate;
						for (let i = 0; i < monthsMissing; i++) {
							incrementedIsoDate = App.getYearMonthFromIso(App.getIncrementedMonthIsoDate(incrementedIsoDate)) + '-01';
							var newEntry = $.extend({}, emptyEntry, {
								Data: incrementedIsoDate,
								GapFilled: 1,
								Duplicated: 0,
							});
							newData.push(newEntry);
							filledGaps.push(incrementedIsoDate);
						}
						newData.push(entry);
						lastEntryDate = entry.Data;
					});

					App.addResult('Marking duplicated months...');
					let prevEntryDate = '';
					const duplicateEntries = [];
					newData.forEach((entry, index) => {
						if (entry.Data && prevEntryDate) {
							const prevEntryMonths = App.getYearMonthFromIso(prevEntryDate);
							const entryMonths = App.getYearMonthFromIso(entry.Data);
							if (entryMonths == prevEntryMonths) {
								entry.Duplicated = 1;
								duplicateEntries.push(App.getYearMonthFromIso(entry.Data));
							}
						}
						prevEntryDate = entry.Data;
					});

					App.addResult('Removing columns D, E, F and G...');
					App.addResult('Reordering columns for output...');
					// Remove cols D, E, F and G when reorganizign cols. When only pick what we want in the output
					App.addResult('<h3 style="color: #0A0">Success!</h3>');
					App.addResult('<b>Input has ' + data.length + ' entries</b>');
					App.addResult('<b>Filled month gaps (' + filledGaps.length + '):</b> ' + filledGaps.map((gap) => App.getYearMonthFromIso(gap)).join(', '));
					App.addResult('<b>Marked month duplicates (' + duplicateEntries.length + '):</b> ' + duplicateEntries.join(', '));
					App.addResult('<b>Output has ' + newData.length + ' entries</b>');
					let [dataCSV, columnsOmmitedFromOutput] = App.convertToCsv(newData);
					App.addResult('<b>Input has ' + columnsOmmitedFromOutput.length + ' columns that were not included in output</b>: ' + columnsOmmitedFromOutput.join(', '));
					App.addResult('<b>Download processed CSV:</b>');
					let $p = App.addResult('<a href="link" style="font-size: 30px">click here to download</a>');
					var today = new Date();
					var date = today.getFullYear() + '_' + (today.getMonth() + 1) + '_' + today.getDate();
					App.setLinkDownload($p.find('a'), 'processed_csv_' + date + '.csv', dataCSV);
				} catch (e) {
					App.addResult('<h3 style="color: red">Ops. There was an error</h3>');
					App.addResult('').text(e.toString());
					App.addResult('Please submit an issue here with the CSV file attatched so I can investigate: <a href="https://github.com/ww9/hydroweb">https://github.com/ww9/hydroweb</a>');
					throw e;
				}
			},
		};

		$(function () {
			$('.textarea_csv').val(sampleCSVFileContents);
			$('.btn_process').click(App.processCSVButtonClick);
		});
	</script>
	<body>
		<h1>HidroWeb data processing tool</h1>
		<h3>1.a) Import ZIP file (not working)</h3>
		<p><input type="file" /></p>
		<h3>1.b) Or paste CSV here</h3>
		<textarea class="textarea_csv" style="width: 100%; height: 200px"> </textarea>
		<h3>2) Press process CSV</h3>
		<button class="btn_process">Process CSV</button>
		<h3>4) Download processed CSV</h3>
		<div class="result" style="border: 1px solid #555; padding: 5px">
			<h2>Upload a CSV ZIP file from <a href="https://www.snirh.gov.br/hidroweb/serieshistoricas">https://www.snirh.gov.br/hidroweb/serieshistoricas</a> to see results here.</h2>
		</div>
	</body>
</html>
