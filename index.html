<!DOCTYPE html>
<html lang="en">
	<meta charset="UTF-8" />
	<title>HidroWeb data processing tool</title>
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<link rel="icon" type="image/png" href="favicon.svg" />
	<style></style>
	<script src="luxon.min.js"></script>
	<script src="jquery-3.6.0.min.js"></script>
	<script src="jquery.csv.js"></script>
	<script src="zip.min.js"></script>
	<script src="sample-input.js"></script>
	<script>
		$(function () {
			var App = {
				clearResult: function (msg) {
					$('.result').html('');
				},
				addResult: function (msg) {
					const $elem = $('<p>' + msg + '<p>');
					$('.result').append($elem);
					return $elem;
				},
				isoDateToMonths: function (dt) {
					let dtParts = dt.split('-').slice(0, 2);
					const yearMonths = parseInt(dtParts[0], 10) * 12;
					const monthMonths = parseInt(dtParts[1], 10);
					return yearMonths + monthMonths;
				},
				isoDateMonthsDiff: function (d1, d2) {
					// '2020-01-31' - '2020-03-01' = 2. Ignores days
					let d1Months = App.isoDateToMonths(d1);
					let d2Months = App.isoDateToMonths(d2);
					return Math.abs(d1Months - d2Months);
				},
				getIncrementedMonthIsoDate: function (isoDate) {
					let [years, months, days] = isoDate.split('-').slice(0, 3);
					if (++months > 12) {
						years++;
						months = 1;
					}
					return years + '-' + months.toString().padStart(2, '0') + '-' + days;
				},
				getYearMonthFromIso: function (isoDate) {
					return isoDate.split('-').slice(0, 2).join('-');
				},
			};

			try {
				App.clearResult();
				App.addResult('Loading CSV...');
				const lines = sampleCSVFileContents.split('\n');
				App.addResult('Removing non-data lines 1 to 14...');
				lines.splice(0, 14);
				App.addResult('Parsing CSV header...');
				const cols = lines.splice(0, 1)[0].split(';');
				cols.push('Duplicated', 'GapFilled');

				App.addResult('Reading CSV entries into an array [{col1: 1, col2: 2}, {col1: 3, col2: 4}]...');
				const data = [];
				lines.forEach((line, lineNumber) => {
					const lineObj = {};
					line.split(';').forEach((cell, colNumber) => {
						const colName = cols[colNumber];
						if (colName == 'Data') {
							cell = cell.split('/').reverse().join('-');
						}
						lineObj[colName] = cell;
					});
					lineObj['Duplicated'] = 0;
					lineObj['GapFilled'] = 0;
					data.push(lineObj);
				});
				let emptyEntry = jQuery.extend({}, data[0]);
				Object.entries(emptyEntry).forEach(([key, value]) => {
					emptyEntry[key] = '';
				});

				App.addResult('Sorting entries in chronological order...');
				data.sort((x, y) => {
					if (x.Data < y.Data) return -1;
					if (x.Data > y.Data) return 1;
					return 0;
				});

				App.addResult('Insert missing months...');
				const newData = [data[0]];
				let lastEntryDate = data[0].Data;
				let filledGaps = [];
				data.forEach((entry, index) => {
					if (index == 0) return;
					const lastEntryDateInMonths = App.isoDateToMonths(lastEntryDate);
					const monthsMissing = Math.max(0, App.isoDateMonthsDiff(lastEntryDate, entry.Data) - 1);
					let incrementedIsoDate = lastEntryDate;
					for (let i = 0; i < monthsMissing; i++) {
						incrementedIsoDate = App.getYearMonthFromIso(App.getIncrementedMonthIsoDate(incrementedIsoDate)) + '-01';
						var newEntry = $.extend({}, emptyEntry, {
							Data: incrementedIsoDate,
							GapFilled: 1,
							Duplicated: 0,
						});
						newData.push(newEntry);
						filledGaps.push(incrementedIsoDate);
					}
					newData.push(entry);
					lastEntryDate = entry.Data;
				});

				App.addResult('Marking duplicated months...');
				let prevEntryDate = '';
				const duplicateEntries = [];
				newData.forEach((entry, index) => {
					if (entry.Data && prevEntryDate) {
						const prevEntryMonths = App.getYearMonthFromIso(prevEntryDate);
						const entryMonths = App.getYearMonthFromIso(entry.Data);
						if (entryMonths == prevEntryMonths) {
							entry.Duplicated = 1;
							duplicateEntries.push(App.getYearMonthFromIso(entry.Data));
						}
					}
					prevEntryDate = entry.Data;
				});

				App.addResult('Removing columns D, E, F and G...');
				App.addResult('Reordering columns for output...');
				// Remove cols D, E, F and G when reorganizign cols. When only pick what we want in the output
				App.addResult('<h1 style="color: #0A0">Success!</h1>');
				App.addResult('<b>Input has ' + data.length + ' entries</b>');
				App.addResult('<b>Filled month gaps (' + filledGaps.length + '):</b> ' + filledGaps.map((gap) => App.getYearMonthFromIso(gap)).join(', '));
				App.addResult('<b>Marked month duplicates (' + duplicateEntries.length + '):</b> ' + duplicateEntries.join(', '));
				App.addResult('<b>Output has ' + newData.length + ' entries</b>');
				App.addResult('<b>Download processed CSV:</b> <a href="link" style="font-size: 30px">click here to download</a>');
			} catch (e) {
				App.addResult('<h1 style="color: red">Ops. There was an error</h1>');
				App.addResult('').text(e.toString());
				App.addResult('Please submit an issue here with the CSV file attatched so I can investigate: <a href="https://github.com/ww9/hydroweb">https://github.com/ww9/hydroweb</a>');
				throw e;
			}
		});
	</script>
	<body>
		<h1>HidroWeb data processing tool</h1>
		<p><input type="file" /></p>
		<div class="result" style="border: 1px solid #555; padding: 5px">
			<h2>Upload a CSV ZIP file from <a href="https://www.snirh.gov.br/hidroweb/serieshistoricas">https://www.snirh.gov.br/hidroweb/serieshistoricas</a> to see results here.</h2>
		</div>
	</body>
</html>
